<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab Architecture Viewer</title>
    <link rel="stylesheet" href="app.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GitLab Architecture Viewer</h1>
            <p>Visualize your project dependencies and manage library versions</p>
        </div>
        
        <!-- Error Message -->
        <div id="error" style="display: none; background: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #f5c6cb;"></div>
        
        <!-- Loading Overlay (Fixed Position) -->
        <div id="loading-overlay" style="display: none;">
            <div class="loading-overlay-content">
                <div class="loading-spinner"></div>
                <div id="loading-text" class="loading-overlay-text">Loading...</div>
            </div>
        </div>
        
        <!-- Global Pending Changes Box (Fixed Position) -->
        <div class="changes-summary" id="global-changes-summary">
            <h4>üìù Pending Changes</h4>
            <div class="changes-summary-content" id="global-changes-content">
                <div class="changes-empty-state" id="global-changes-empty">
                    <div class="changes-empty-state-icon">üìã</div>
                    <div class="changes-empty-state-text">No changes yet<br>Start editing to see pending changes</div>
                </div>
                <div id="global-changes-list" class="changes-list" style="display: none;"></div>
                <div id="global-changes-actions" style="display: none;">
                    <div class="branch-name-section">
                        <label for="global-target-branch" class="branch-label">Target Branch:</label>
                        <input type="text" 
                               id="global-target-branch" 
                               class="branch-name-input"
                               placeholder="e.g., feature/update-dependencies">
                    </div>
                    <div class="changes-actions">
                        <button onclick="clearAllChanges()" class="btn-clear-changes">
                            ‚ùå Clear Changes
                        </button>
                        <button onclick="applyGlobalChanges()" class="btn-apply-changes">
                            üíæ Save All Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <!-- Main Project Search Section -->
            <div class="section">
                <h3>üîç Search Projects</h3>
                <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">
                    Find and manage Go projects with library version control
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="search-go-version">Go Version:</label>
                        <div class="autocomplete-container">
                            <input type="text" id="search-go-version" placeholder="e.g., 1.21, 1.20" autocomplete="off">
                            <div id="go-version-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="go-version-comparison">Go Version Comparison:</label>
                        <select id="go-version-comparison">
                            <option value="">Exact Match</option>
                            <option value="greater">Greater Than</option>
                            <option value="greater_equal">Greater or Equal</option>
                            <option value="less">Less Than</option>
                            <option value="less_equal">Less or Equal</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group library-filters">
                        <label for="search-library">Library Filters:</label>
                        <div class="library-inputs">
                            <div class="autocomplete-container">
                                <input type="text" id="search-library" placeholder="Library name (e.g., gin, echo, fiber)" autocomplete="off">
                                <div id="library-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            </div>
                            <div class="autocomplete-container">
                                <input type="text" id="search-library-version" placeholder="Version (e.g., v1.9.1)" autocomplete="off" disabled>
                                <div id="library-version-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            </div>
                            <select id="version-comparison">
                                <option value="exact">Exact Match</option>
                                <option value="gte">Greater or Equal</option>
                                <option value="lte">Less or Equal</option>
                                <option value="gt">Greater Than</option>
                                <option value="lt">Less Than</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="search-group">Group:</label>
                        <input type="text" id="search-group" placeholder="e.g., nghis">
                    </div>
                    <div class="form-group">
                        <label for="search-tag">Tag:</label>
                        <input type="text" id="search-tag" placeholder="e.g., services">
                    </div>
                </div>
                <button onclick="searchProjects()">Search Projects</button>
                <button onclick="clearSearch()">Clear Search</button>
            </div>

            <div class="section">
                <div id="project-results" class="project-results" style="display: none;">
                    <h3>Search Results</h3>
                    
                    <!-- Quick Search Filter -->
                    <div class="quick-search-section">
                        <div class="quick-search-container">
                            <input type="text" 
                                   id="quick-search" 
                                   class="quick-search-input" 
                                   placeholder="üîç Quick filter by project name..."
                                   oninput="filterProjects()">
                            <button onclick="clearQuickSearch()" class="btn-clear-search" title="Clear filter">‚úï</button>
                        </div>
                        <div id="filter-count" class="filter-count"></div>
                    </div>
                    
                    <div id="search-stats" class="search-stats" style="display: none;"></div>
                    <div id="projects-list"></div>
                </div>
            </div>


            <!-- Advanced Configuration (Collapsed by default) -->
            <div class="section">
                <h3 onclick="toggleAdvancedConfig()" style="cursor: pointer; user-select: none;">
                    ‚öôÔ∏è Advanced Configuration <span id="config-toggle">‚ñº</span>
                </h3>
                <div id="advanced-config" style="display: none;">
                    <!-- GitLab Configuration -->
                    <div class="section">
                        <h3>üîë GitLab Configuration</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="gitlab-token">GitLab API Token:</label>
                                <input type="password" autocomplete="new-password" id="gitlab-token" placeholder="Enter your GitLab API token">
                                <small style="color: #7f8c8d; font-size: 12px;">Required for accessing GitLab projects</small>
                            </div>
                            <div class="form-group">
                                <button onclick="testGitLabConnection()">üîó Test Connection</button>
                                <button onclick="saveConfiguration()">üíæ Save Config</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="gitlab-group">Group:</label>
                                <input type="text" id="gitlab-group" placeholder="e.g., nghis">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="gitlab-tag">Tag:</label>
                                <input type="text" id="gitlab-tag" placeholder="e.g., services">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="gitlab-branch">Branch:</label>
                                <input type="text" id="gitlab-branch" placeholder="e.g., main">
                            </div>
                        </div>
                    </div>

                    <!-- GitLab URL Information -->
                    <div class="section">
                        <h3>üåê GitLab URL Information</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="gitlab-base-url">GitLab Base URL:</label>
                                <input type="text" id="gitlab-base-url" readonly placeholder="Will be populated automatically">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="gitlab-api-endpoint">API Endpoint:</label>
                                <input type="text" id="gitlab-api-endpoint" readonly placeholder="Will be populated automatically">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="gitlab-full-url">Full API URL:</label>
                                <input type="text" id="gitlab-full-url" readonly placeholder="Complete URL being parsed for projects">
                            </div>
                            <div class="form-group">
                                <button onclick="updateUrlDisplay()">üîÑ Update URL</button>
                            </div>
                        </div>
                    </div>

                    <!-- Cache Management Section -->
                    <div class="section">
                        <h3>üíæ Cache Management</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="search-mode">Search Mode:</label>
                                <select id="search-mode">
                                    <option value="cache">Use Cache (Fast)</option>
                                    <option value="live">Live Search (Fresh Data)</option>
                                    <option value="cache-first">Cache First, then Live</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button onclick="loadInitialCache()">üì• Load Initial Cache</button>
                                <button onclick="refreshCache()">üîÑ Refresh Cache</button>
                                <button onclick="clearCache()">üóëÔ∏è Clear Cache</button>
                            </div>
                        </div>
                        <div class="cache-info">
                            <small>üí° <strong>Load Initial Cache</strong> fetches all projects and analyzes their Go modules (go.mod files) to populate Go versions and library dependencies. This enables fast filtering by Go version and libraries.<br>
                            üîÑ <strong>Hash-Based Cache:</strong> Cache uses content hashes instead of TTL - data stays valid until manually cleared or projects change.</small>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="webhook-project-id">Test: Refresh Project Cache:</label>
                                <input type="number" id="webhook-project-id" placeholder="Project ID (e.g., 123)">
                            </div>
                            <div class="form-group">
                                <button onclick="refreshProjectCache()">üîÑ Refresh Project</button>
                            </div>
                        </div>
                        <div class="cache-info">
                            <small>üîó <strong>GitLab Webhook URL:</strong> <code>POST /api/webhook/gitlab</code><br>
                            <strong>For GitLab Integration:</strong> Add this URL to your GitLab project webhooks:<br>
                            <code>http://your-server:8080/api/webhook/gitlab?token=your_gitlab_token</code><br>
                            <strong>Or use X-Gitlab-Token header:</strong> <code>X-Gitlab-Token: your_gitlab_token</code></small>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <button onclick="checkChangedProjects()">üîç Check Changed Projects</button>
                            </div>
                        </div>
                        <div class="cache-info">
                            <small>üîç <strong>Change Detection:</strong> Check which projects have changed since last cache build using content hash comparison. Only projects with actual changes are detected.</small>
                        </div>
                        <div id="cache-stats" class="cache-stats" style="display: none;">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">Total Cached:</span>
                                    <span class="stat-value" id="total-cached">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Cache Type:</span>
                                    <span class="stat-value" id="cache-type">Hash-Based</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Search Hashes:</span>
                                    <span class="stat-value" id="search-hashes">0</span>
                                </div>
                            </div>
                        </div>
                        <span id="cache-status" style="margin-left: 10px; font-size: 14px;"></span>
                    </div>
                </div>
            </div>
            
            <!-- Architecture Generation Section -->
            <div class="section">
                <h3>üèóÔ∏è Architecture Generation</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="architecture-type">Architecture Type:</label>
                        <select id="architecture-type" onchange="toggleArchitectureOptions()">
                            <option value="single">Single Module</option>
                            <option value="full">Full Architecture (All Projects)</option>
                        </select>
                    </div>
                </div>
                <div id="single-module-options">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="module">Module/Service:</label>
                            <div class="autocomplete-container">
                                <input type="text" id="module" placeholder="e.g., drg or full module path" autocomplete="off">
                                <div id="module-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="radius">Radius:</label>
                            <input type="number" id="radius" value="1" min="0" max="5">
                        </div>
                        <div class="form-group">
                            <label for="ref">Git Ref:</label>
                            <input type="text" id="ref" placeholder="branch/commit (optional)">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ignore">Ignore:</label>
                        <input type="text" id="ignore" placeholder="Comma-separated patterns to ignore">
                    </div>
                    <div class="form-group">
                        <label for="include-tests">Include Tests:</label>
                        <input type="checkbox" id="include-tests">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <button onclick="generateArchitecture()">üèóÔ∏è Generate Architecture</button>
                        <button onclick="downloadArchitecture()">üì• Download</button>
                    </div>
                </div>
            </div>

            <!-- Architecture Display Section -->
            <div class="section">
                <div id="architecture-results" style="display: none;">
                    <h3>Architecture Diagram</h3>
                    <div id="architecture-diagram"></div>
                </div>
            </div>

            <!-- OpenAPI Documentation Section -->
            <div class="section">
                <h3>üìö OpenAPI Documentation</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="openapi-search">Search Projects:</label>
                        <input type="text" id="openapi-search" placeholder="Search for projects with OpenAPI specs">
                    </div>
                    <div class="form-group">
                        <button onclick="loadProjectsWithOpenAPI()">üîç Find OpenAPI Projects</button>
                    </div>
                </div>
                <div id="openapi-projects" style="display: none;">
                    <h4>Projects with OpenAPI Documentation</h4>
                    <div id="openapi-projects-list"></div>
                </div>
                <div id="openapi-content" style="display: none;">
                    <h4>OpenAPI Documentation</h4>
                    <div id="swagger-ui"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js?v=202510244700"></script>
    <script src="app-library-helpers.js?v=202510244700"></script>
    <script>
        // Toggle advanced configuration
        function toggleAdvancedConfig() {
            const configDiv = document.getElementById('advanced-config');
            const toggle = document.getElementById('config-toggle');
            
            if (configDiv.style.display === 'none') {
                configDiv.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                configDiv.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
    </script>
</body>
</html>